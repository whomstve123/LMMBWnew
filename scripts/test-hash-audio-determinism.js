// This script tests that the same face hash always produces the same audio URL, and different hashes produce different URLs.
// Run with: node scripts/test-hash-audio-determinism.js

const fetch = require('node-fetch');

const API_URL = 'https://opulent-fishstick-xg95qgxgxrqhx57-3000.app.github.dev/api/generateTrack'; // Codespaces public URL

function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

async function fetchWithRetry(hash, retries = 3, delayMs = 2000) {
  for (let i = 0; i < retries; i++) {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ faceHash: hash }),
    });
    const raw = await res.text();
    console.log(`Raw response for hash '${hash}':\n${raw}`);
    try {
      const data = JSON.parse(raw);
      if (data && data.audioUrl) return data;
    } catch (e) {
      console.error(`JSON parse error for hash '${hash}':`, e);
    }
    if (i < retries - 1) {
      await sleep(delayMs);
    }
  }
  return null;
}

async function testHashDeterminism() {
  // NOTE: These are dummy hashes. For real determinism, use hashes generated by your app's face descriptor logic.
  const testHashes = [
    'test-face-hash-123',
    'test-face-hash-123', // repeat
    'another-face-hash-456',
  ];

  const results = [];

  for (let i = 0; i < testHashes.length; i++) {
    const hash = testHashes[i];
    if (i === 1) {
      // Wait extra time before repeating the same hash to allow for audio generation
      await sleep(4000);
    }
    // Increase retries and delay for slow audio generation
    const data = await fetchWithRetry(hash, 8, 4000);
    if (!data) {
      console.error(`Failed to get valid JSON for hash: ${hash}`);
      continue;
    }
    results.push({ hash, audioUrl: data.audioUrl, stems: data.stems, trackId: data.trackId });
    console.log(`Hash: ${hash}\n  Audio URL: ${data.audioUrl}\n  Track ID: ${data.trackId}\n  Stems: ${JSON.stringify(data.stems)}\n`);
  }

  // Check determinism
  if (results[0] && results[1] && results[0].audioUrl === results[1].audioUrl && results[0].trackId === results[1].trackId) {
    console.log('PASS: Same hash yields same audio and track ID.');
  } else {
    console.error('FAIL: Same hash yields different audio or track ID!');
  }

  if (results[0] && results[2] && results[0].audioUrl !== results[2].audioUrl && results[0].trackId !== results[2].trackId) {
    console.log('PASS: Different hash yields different audio and track ID.');
  } else {
    console.error('FAIL: Different hash yields same audio or track ID!');
  }
}

testHashDeterminism().catch(console.error);
